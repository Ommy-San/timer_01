<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Ommyz Visual Timer</title>
  <style>
    body {
      margin: 0;
      background-color: #005133;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      justify-content: center;
    }
    canvas {
      background-color: #005133;
    }
    .controls {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      align-items: center;
    }
    .hide {
      display: none;
    }
    #footer {
      position: fixed;
      right: 10px;
      bottom: 10px;
      font-size: 12px;
      color: #eee;
      opacity: 0.5;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <canvas id="timerCanvas"></canvas>
  <div class="controls" id="controlPanel">
    <label>時間:
      <input type="number" id="timeInputMinutes" min="0" max="60" value="0"> 分
      <input type="number" id="timeInputSeconds" min="10" max="59" value="10"> 秒
    </label>
    <label>円サイズ:<input type="range" id="sizeSlider" min="20" max="80" value="40"> %</label>
    <label>画像サイズ:<input type="range" id="imgSizeSlider" min="20" max="100" value="40"> %</label>
    <button id="imageBtn">画像選択</button>
    <input type="file" id="imageInput" accept="image/*" style="display:none">
    <button id="startBtn">開始</button>
    <button id="resetBtn">リセット</button>
  </div>
  <button id="stopBtn" class="hide">停止</button>
  <div id="footer">Ommyz Visual Timer</div>

  <script>
    const canvas = document.getElementById("timerCanvas");
    const ctx = canvas.getContext("2d");
    const timeInputMinutes = document.getElementById("timeInputMinutes");
    const timeInputSeconds = document.getElementById("timeInputSeconds");
    const sizeSlider = document.getElementById("sizeSlider");
    const imgSizeSlider = document.getElementById("imgSizeSlider");
    const imageBtn = document.getElementById("imageBtn");
    const imageInput = document.getElementById("imageInput");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const stopBtn = document.getElementById("stopBtn");
    const controlPanel = document.getElementById("controlPanel");

    let totalTime = getTotalTimeFromInputs();
    let startTime = null;
    let elapsedTime = 0;
    let radius, centerX, centerY;
    let animationId = null;
    let isRunning = false;
    let isFinished = false;
    let sizePercent = parseInt(sizeSlider.value);
    let imgScalePercent = parseInt(imgSizeSlider.value);

    let originalImg = null;
    let imgCanvas = null;
    let imgX = 0, imgY = 0;

    let audioCtx = null;

    function getTotalTimeFromInputs() {
      let min = parseInt(timeInputMinutes.value) || 0;
      let sec = parseInt(timeInputSeconds.value) || 0;
      let total = min * 60 + sec;
      return Math.max(10, Math.min(total, 3600));
    }

    function resizeCanvas() {
      const size = window.innerWidth * (sizePercent / 100);
      canvas.width = size;
      canvas.height = size;
      radius = size * 0.4;
      centerX = canvas.width / 2;
      centerY = canvas.height / 2;
      if (originalImg) resizeImage();
    }

    function resizeImage() {
      const maxSize = radius * 2 * 0.7;
      const desiredSize = maxSize * (imgScalePercent / 100);
      const aspect = originalImg.width / originalImg.height;

      imgCanvas = document.createElement("canvas");
      if (aspect >= 1) {
        imgCanvas.width = desiredSize;
        imgCanvas.height = desiredSize / aspect;
      } else {
        imgCanvas.height = desiredSize;
        imgCanvas.width = desiredSize * aspect;
      }

      const tempCtx = imgCanvas.getContext("2d");
      tempCtx.drawImage(originalImg, 0, 0, imgCanvas.width, imgCanvas.height);

      imgX = centerX - imgCanvas.width / 2;
      imgY = centerY - imgCanvas.height / 2;
    }

    function applyGrayscale(canvas) {
      const ctx = canvas.getContext("2d");
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        const avg = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        data[i] = data[i + 1] = data[i + 2] = avg;
      }
      ctx.putImageData(imgData, 0, 0);
    }

    function drawTimer(percentage) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let color = percentage <= 0.05 ? "red" : "limegreen";

      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = "#ccc";
      ctx.lineWidth = radius * 0.2;
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 - 2 * Math.PI * percentage, true);
      ctx.closePath();
      ctx.fillStyle = color;
      ctx.fill();

      if (imgCanvas) {
        if (isFinished) {
          const temp = document.createElement("canvas");
          temp.width = imgCanvas.width;
          temp.height = imgCanvas.height;
          const tctx = temp.getContext("2d");
          tctx.drawImage(imgCanvas, 0, 0);
          applyGrayscale(temp);
          ctx.drawImage(temp, imgX, imgY);
        } else {
          ctx.drawImage(imgCanvas, imgX, imgY);
        }
      }
    }

    function animateTimer(timestamp) {
      if (!startTime) startTime = timestamp;
      elapsedTime = (timestamp - startTime) / 1000;
      let remaining = Math.max(totalTime - elapsedTime, 0);
      drawTimer(remaining / totalTime);
      if (remaining > 0) {
        animationId = requestAnimationFrame(animateTimer);
      } else {
        isRunning = false;
        isFinished = true;
        drawTimer(0);
        playAlarm();
        controlPanel.classList.remove("hide");
        stopBtn.classList.add("hide");
      }
    }

    function playAlarm() {
      if (!audioCtx) return;
      const notes = [
        { freq: 1046.5, duration: 500 }, { freq: 1568.0, duration: 500 },
        { freq: 1760.0, duration: 500 }, { freq: 1568.0, duration: 1000 }
      ];
      let now = audioCtx.currentTime;
      for (let note of notes) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(note.freq, now);
        gain.gain.setValueAtTime(0.2, now);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + note.duration / 1000);
        now += note.duration / 1000;
      }
    }

    function startTimer() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      totalTime = getTotalTimeFromInputs();
      elapsedTime = 0;
      startTime = null;
      isFinished = false;
      isRunning = true;
      controlPanel.classList.add("hide");
      stopBtn.classList.remove("hide");
      cancelAnimationFrame(animationId);
      animationId = requestAnimationFrame(animateTimer);
    }

    function stopTimer() {
      if (isRunning) {
        cancelAnimationFrame(animationId);
        isRunning = false;
        controlPanel.classList.remove("hide");
        stopBtn.classList.add("hide");
      }
    }

    function resetTimer() {
      cancelAnimationFrame(animationId);
      isRunning = false;
      isFinished = false;
      elapsedTime = 0;
      startTime = null;
      imgCanvas = null;
      originalImg = null;
      imageInput.value = "";
      timeInputMinutes.value = 0;
      timeInputSeconds.value = 10;
      controlPanel.classList.remove("hide");
      stopBtn.classList.add("hide");
      drawTimer(1);
    }

    function handleImageFile(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          originalImg = img;
          resizeImage();
          drawTimer(1);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // イベント
    window.addEventListener("resize", () => {
      resizeCanvas();
      drawTimer(1);
    });

    imageBtn.addEventListener("click", () => imageInput.click());
    imageInput.addEventListener("change", e => {
      if (e.target.files.length > 0) handleImageFile(e.target.files[0]);
    });

    canvas.addEventListener("dragover", e => e.preventDefault());
    canvas.addEventListener("drop", e => {
      e.preventDefault();
      if (e.dataTransfer.files.length > 0) handleImageFile(e.dataTransfer.files[0]);
    });

    sizeSlider.addEventListener("input", () => {
      sizePercent = parseInt(sizeSlider.value);
      resizeCanvas();
      drawTimer(1);
    });

    imgSizeSlider.addEventListener("input", () => {
      imgScalePercent = parseInt(imgSizeSlider.value);
      if (originalImg) {
        resizeImage();
        drawTimer(1);
      }
    });

    startBtn.addEventListener("click", startTimer);
    stopBtn.addEventListener("click", stopTimer);
    resetBtn.addEventListener("click", resetTimer);

    // 初期化
    resizeCanvas();
    drawTimer(1);
  </script>
</body>
</html>